<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Telegram æ‰«ç ç™»å½• - å®šæ—¶æ¶ˆæ¯ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        .upload-area {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 10px;
        }
        #status, #uploadStatus, #mediaUploadStatus {
            margin-top: 20px;
            color: #666;
        }
        .agreement {
            margin-top: 20px;
            font-size: 12px;
            color: #999;
        }
        .agreement a {
            color: #0088cc;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ“± Telegram è´¦å·æˆæƒ</h1>
    <p>è¯·æ‰«ç å®Œæˆæˆæƒï¼Œç„¶åä¸Šä¼ ä½ çš„Sessionæ–‡ä»¶</p>
    
    <!-- Telegramå®˜æ–¹æ‰«ç ç™»å½•ç»„ä»¶ -->
    <script async src="https://telegram.org/js/telegram-widget.js?22"
            data-telegram-login="{{ bot_username }}"
            data-size="large"
            data-auth-url="/auth"
            data-request-access="write"></script>

    <!-- ç”¨æˆ·åè®® -->
    <div class="agreement">
        <p>ç‚¹å‡»æˆæƒå³è¡¨ç¤ºä½ åŒæ„<a href="/privacy" target="_blank">ã€Šéšç§æ”¿ç­–ã€‹</a>ï¼Œæˆ‘ä»¬ä¸ä¼šæ”¶é›†ä½ çš„æ‰‹æœºå·ã€éªŒè¯ç ã€äºŒçº§å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯</p>
    </div>

    <!-- Sessionæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-area" id="uploadArea" style="display: none;">
        <h3>ğŸ“¤ ä¸Šä¼ ä½ çš„Sessionæ–‡ä»¶</h3>
        <p>è¯·å…ˆæœ¬åœ°è¿è¡Œç™»å½•è„šæœ¬ç”Ÿæˆsessionæ–‡ä»¶ï¼Œå†ä¸Šä¼ </p>
        <input type="file" id="sessionFile" accept=".session">
        <button onclick="uploadFile()">ä¸Šä¼ </button>
        <p id="uploadStatus"></p>
        
        <!-- æœ¬åœ°ç™»å½•è„šæœ¬ç¤ºä¾‹ -->
        <div style="margin-top: 20px; text-align: left; font-size: 14px;">
            <h4>æœ¬åœ°ç™»å½•è„šæœ¬ï¼ˆç”Ÿæˆsessionæ–‡ä»¶ï¼‰ï¼š</h4>
            <pre id="loginScript">
from pyrogram import Client

# æ›¿æ¢ä¸ºä½ çš„APIä¿¡æ¯
API_ID = {{ api_id }}
API_HASH = "{{ api_hash }}"
USER_ID = "{{ user_id }}"  # æ›¿æ¢ä¸ºä½ çš„Telegramç”¨æˆ·ID

# åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆæ”¯æŒä¸¤æ­¥éªŒè¯ï¼‰
client = Client(
    name=f"user_{USER_ID}",
    api_id=API_ID,
    api_hash=API_HASH
)

with client:
    print("âœ… ç™»å½•æˆåŠŸï¼å·²ç”Ÿæˆ session æ–‡ä»¶ï¼šuser_{USER_ID}.session")
            </pre>
        </div>
    </div>

    <!-- åª’ä½“æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-area" id="mediaUploadArea" style="margin-top: 30px; display: none;">
        <h3>ğŸ–¼ï¸ ä¸Šä¼ åª’ä½“æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</h3>
        <input type="file" id="mediaFile">
        <button onclick="uploadMedia()">ä¸Šä¼ åª’ä½“</button>
        <p id="mediaUploadStatus"></p>
    </div>

    <div id="status"></div>

    <script>
        // å­˜å‚¨æˆæƒåçš„ç”¨æˆ·ID
        let userId = "";

        // ç›‘å¬æˆæƒå›è°ƒï¼ˆä»URLå‚æ•°è·å–ç”¨æˆ·IDï¼‰
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const user_id = urlParams.get('user_id');
            if (user_id) {
                userId = user_id;
                document.getElementById('uploadArea').style.display = 'block';
                document.getElementById('mediaUploadArea').style.display = 'block';
                // æ›¿æ¢è„šæœ¬ä¸­çš„ç”¨æˆ·ID
                const scriptText = document.getElementById('loginScript').innerText
                    .replace("{{ user_id }}", user_id)
                    .replace("{{ api_id }}", "{{ api_id }}")
                    .replace("{{ api_hash }}", "{{ api_hash }}");
                document.getElementById('loginScript').innerText = scriptText;
            }
        };

        // ä¸Šä¼ Sessionæ–‡ä»¶
        function uploadFile() {
            const fileInput = document.getElementById('sessionFile');
            const file = fileInput.files[0];
            if (!file) {
                document.getElementById('uploadStatus').innerText = "âŒ è¯·é€‰æ‹©sessionæ–‡ä»¶";
                return;
            }

            const formData = new FormData();
            formData.append('session_file', file);
            formData.append('user_id', userId);

            fetch('/upload_session', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      document.getElementById('uploadStatus').innerText = "âœ… ä¸Šä¼ æˆåŠŸï¼ç°åœ¨å¯ä»¥å›åˆ°Telegramæœºå™¨äººä½¿ç”¨åŠŸèƒ½";
                  } else {
                      document.getElementById('uploadStatus').innerText = "âŒ ä¸Šä¼ å¤±è´¥ï¼š" + data.message;
                  }
              }).catch(error => {
                  document.getElementById('uploadStatus').innerText = "âŒ ç½‘ç»œé”™è¯¯ï¼š" + error;
              });
        }

        // ä¸Šä¼ åª’ä½“æ–‡ä»¶
        function uploadMedia() {
            const fileInput = document.getElementById('mediaFile');
            const file = fileInput.files[0];
            if (!file) {
                document.getElementById('mediaUploadStatus').innerText = "âŒ è¯·é€‰æ‹©åª’ä½“æ–‡ä»¶";
                return;
            }

            const formData = new FormData();
            formData.append('media_file', file);
            formData.append('user_id', userId);

            fetch('/upload_media', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      document.getElementById('mediaUploadStatus').innerText = "âœ… åª’ä½“ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶IDï¼š" + data.filename;
                  } else {
                      document.getElementById('mediaUploadStatus').innerText = "âŒ ä¸Šä¼ å¤±è´¥ï¼š" + data.message;
                  }
              }).catch(error => {
                  document.getElementById('mediaUploadStatus').innerText = "âŒ ç½‘ç»œé”™è¯¯ï¼š" + error;
              });
        }
    </script>
</body>
</html>